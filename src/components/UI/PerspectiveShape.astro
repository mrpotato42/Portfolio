---
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"div"> {
  width?: number | string;
  height?: number | string;
  perspective?: number; // En píxeles. 0 para desactivar.
  perspectiveOrigin?: string; // Ej: 'center', 'top right', '50% 50%'
  rotationX?: number; // Rotación en grados
  rotationY?: number; // Rotación en grados
  rotationZ?: number; // Rotación en grados
  scale?: number; // Escala (1 = 100%, 1.5 = 150%)
  href?: string; // URL para el enlace
}

const {
  width = "90%",
  height,
  perspective = 1000,
  perspectiveOrigin = "center",
  rotationX = 0,
  rotationY = 0,
  rotationZ = 0,
  scale = 1,
  href: rawHref,
  class: className,
  ...rest
} = Astro.props;



const href: string = (() => {
  if (rawHref == "modal") {
    return "#modal";
  } else {
    return rawHref || "404";
  }
})();

const transformStyle = {
  '--base-transform': `rotateX(${rotationX}deg) rotateY(${rotationY}deg) rotateZ(${rotationZ}deg) scale(${scale})`,
  transform: 'var(--base-transform)'
};

const containerStyle = {
  perspective: perspective > 0 ? `${perspective}px` : "none",
  "perspective-origin": perspectiveOrigin,
  width,
  height: typeof height === "number" ? `md:${height}px` : height,
};
---

<div style={containerStyle} class:list={["perspective-container", className]} {...rest}>
  <div class="perspective-card" style={transformStyle}>
    <a href={href} class="perspective-link">
      <slot />
    </a>
  </div>
</div>

<style>
  @keyframes ps-pulse {
    0%, 100% { transform: var(--base-transform) translateZ(0) scale(1); opacity: 1; }
    50% { transform: var(--base-transform) translateZ(12px) scale(1.2); opacity: 1; }
  }
  .ps-inner.ps-anim { animation: ps-pulse 900ms ease-in-out infinite; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.ps-container').forEach((container) => {
      const inner = container.querySelector('.ps-inner');
      if (!inner) return;
      let stopAfter = false;
      container.addEventListener('mouseenter', () => {
        inner.classList.add('ps-anim');
        stopAfter = false;
      });
      container.addEventListener('mouseleave', () => {
        stopAfter = true;
      });
      inner.addEventListener('animationiteration', () => {
        if (stopAfter) {
          inner.classList.remove('ps-anim');
          stopAfter = false;
        }
      });
    });
  });
</script>
